name: Release

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.1

      - name: Run tests
        run: zig build test

      - name: Build and test native
        run: |
          zig build -Doptimize=ReleaseFast
          ./zig-out/bin/flooc --version
          ./zig-out/bin/floos --version

  cross-compile:
    name: Cross-Compile Release Binaries
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' || startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.1

      - name: Build all platforms (baseline)
        run: zig build release-all -Drelease_cpu=baseline

      - name: Build optimized x86_64 variants (Haswell)
        run: |
          # Save baseline x86_64 builds first
          mkdir -p zig-out/release-baseline
          cp -r zig-out/release/x86_64-linux-gnu zig-out/release-baseline/
          cp -r zig-out/release/x86_64-macos zig-out/release-baseline/

          # Build Haswell-optimized (enables AES-NI for both Linux and macOS x86_64)
          zig build release-all -Drelease_cpu=haswell

          # Rename Haswell builds
          mv zig-out/release/x86_64-linux-gnu zig-out/release/x86_64-linux-gnu-haswell
          mv zig-out/release/x86_64-macos zig-out/release/x86_64-macos-haswell

          # Restore baseline builds
          mv zig-out/release-baseline/x86_64-linux-gnu zig-out/release/
          mv zig-out/release-baseline/x86_64-macos zig-out/release/

      - name: Build optimized Apple Silicon (M1+)
        run: |
          # Save baseline aarch64-macos first
          mkdir -p zig-out/release-baseline
          cp -r zig-out/release/aarch64-macos zig-out/release-baseline/

          # Build Apple M1-optimized (enables ARM crypto extensions)
          zig build release-all -Drelease_cpu=apple_m1

          # Rename Apple Silicon optimized build
          mv zig-out/release/aarch64-macos zig-out/release/aarch64-macos-m1

          # Restore baseline build
          mv zig-out/release-baseline/aarch64-macos zig-out/release/

      - name: Build Raspberry Pi variant (Cortex-A76)
        run: |
          # Save baseline aarch64-linux-gnu first
          mkdir -p zig-out/release-baseline
          cp -r zig-out/release/aarch64-linux-gnu zig-out/release-baseline/

          # Build Cortex-A76 optimized (Raspberry Pi 5)
          zig build release-all -Drelease_cpu=cortex_a76

          # Rename Raspberry Pi build
          mv zig-out/release/aarch64-linux-gnu zig-out/release/aarch64-linux-gnu-rpi

          # Restore baseline build
          mv zig-out/release-baseline/aarch64-linux-gnu zig-out/release/

      - name: Package artifacts
        run: |
          mkdir -p artifacts

          # Package each target (baseline + optimized variants)
          for target in x86_64-linux-gnu x86_64-linux-gnu-haswell aarch64-linux-gnu aarch64-linux-gnu-rpi x86_64-macos x86_64-macos-haswell aarch64-macos aarch64-macos-m1; do
            if [ -d "zig-out/release/$target" ]; then
              mkdir -p "artifacts/$target"
              cp zig-out/release/$target/flooc "artifacts/$target/"
              cp zig-out/release/$target/floos "artifacts/$target/"
              cp README.md flooc.toml.example floos.toml.example "artifacts/$target/"

              cd artifacts
              tar czf "floo-$target.tar.gz" "$target/"
              cd ..
            fi
          done

      - name: Upload Linux x86_64
        uses: actions/upload-artifact@v4
        with:
          name: floo-linux-x86_64
          path: artifacts/floo-x86_64-linux-gnu.tar.gz

      - name: Upload Linux x86_64 (Haswell)
        uses: actions/upload-artifact@v4
        with:
          name: floo-linux-x86_64-haswell
          path: artifacts/floo-x86_64-linux-gnu-haswell.tar.gz
        if: hashFiles('artifacts/floo-x86_64-linux-gnu-haswell.tar.gz') != ''

      - name: Upload Linux aarch64
        uses: actions/upload-artifact@v4
        with:
          name: floo-linux-aarch64
          path: artifacts/floo-aarch64-linux-gnu.tar.gz

      - name: Upload Linux aarch64 (Raspberry Pi)
        uses: actions/upload-artifact@v4
        with:
          name: floo-linux-aarch64-rpi
          path: artifacts/floo-aarch64-linux-gnu-rpi.tar.gz
        if: hashFiles('artifacts/floo-aarch64-linux-gnu-rpi.tar.gz') != ''

      - name: Upload macOS x86_64
        uses: actions/upload-artifact@v4
        with:
          name: floo-macos-x86_64
          path: artifacts/floo-x86_64-macos.tar.gz

      - name: Upload macOS x86_64 (Haswell)
        uses: actions/upload-artifact@v4
        with:
          name: floo-macos-x86_64-haswell
          path: artifacts/floo-x86_64-macos-haswell.tar.gz
        if: hashFiles('artifacts/floo-x86_64-macos-haswell.tar.gz') != ''

      - name: Upload macOS aarch64
        uses: actions/upload-artifact@v4
        with:
          name: floo-macos-aarch64
          path: artifacts/floo-aarch64-macos.tar.gz

      - name: Upload macOS aarch64 (M1+)
        uses: actions/upload-artifact@v4
        with:
          name: floo-macos-aarch64-m1
          path: artifacts/floo-aarch64-macos-m1.tar.gz
        if: hashFiles('artifacts/floo-aarch64-macos-m1.tar.gz') != ''

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: cross-compile
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify version matches tag
        run: |
          # Extract version from build.zig.zon
          VERSION=$(grep -oP '\.version = "\K[^"]+' build.zig.zon)
          # Extract version from git tag (remove 'v' prefix)
          TAG_VERSION=${GITHUB_REF#refs/tags/v}

          echo "build.zig.zon version: $VERSION"
          echo "Git tag version: $TAG_VERSION"

          if [ "$VERSION" != "$TAG_VERSION" ]; then
            echo "‚ùå ERROR: Version mismatch!"
            echo "   build.zig.zon has version '$VERSION'"
            echo "   Git tag is 'v$TAG_VERSION'"
            echo ""
            echo "Please update build.zig.zon to version \"$TAG_VERSION\" before creating this release."
            exit 1
          fi

          echo "‚úÖ Version match confirmed: $VERSION"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          find release-artifacts -name "*.tar.gz" -exec cp {} release-assets/ \;
          ls -lh release-assets/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release-assets/*.tar.gz
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## Floo ${{ github.ref_name }}

            **High-throughput tunneling in Zig - Zero dependencies, maximum performance**

            ### üöÄ Performance (Apple M1 MacBook Air)
            - **29.4 Gbps** encrypted throughput (AEGIS-128L cipher)
            - **62% faster** than Rathole
            - **194% faster** than FRP

            ### üì¶ Binary Sizes
            - Client (`flooc`): 394 KB
            - Server (`floos`): 277 KB
            - **Total: 671 KB**

            ### ‚ú® Key Features
            - üîê Noise XX + PSK authentication (5 AEAD ciphers)
            - üöÄ Multi-service multiplexing
            - ‚ö° Parallel tunnels with round-robin load balancing
            - üåê Proxy support (SOCKS5 + HTTP CONNECT)
            - üíì Heartbeat supervision & auto-reconnect
            - üîÑ Hot config reload (SIGHUP)
            - üìä Built-in diagnostics (`--doctor`, `--ping`)
            - üéØ Per-service token authentication

            ### üì• Installation

            **Choose your platform:**

            | Platform | Download | CPU Optimization |
            |----------|----------|------------------|
            | **Linux x86_64** | `floo-x86_64-linux-gnu.tar.gz` | Baseline (compatible with all CPUs) |
            | **Linux x86_64 (Haswell+)** ‚ö° | `floo-x86_64-linux-gnu-haswell.tar.gz` | Optimized for Intel Haswell+ (2013+) with AES-NI |
            | **Linux aarch64** | `floo-aarch64-linux-gnu.tar.gz` | ARM64 servers (baseline) |
            | **Linux aarch64 (Raspberry Pi)** ü•ß | `floo-aarch64-linux-gnu-rpi.tar.gz` | Raspberry Pi 4/5 (Cortex-A76) |
            | **macOS Intel** | `floo-x86_64-macos.tar.gz` | Intel Macs (baseline) |
            | **macOS Intel (Haswell+)** ‚ö° | `floo-x86_64-macos-haswell.tar.gz` | Intel Macs (2013+) with AES-NI |
            | **macOS Apple Silicon** | `floo-aarch64-macos.tar.gz` | M1/M2/M3/M4 (baseline) |
            | **macOS Apple Silicon (M1+)** ‚ö° | `floo-aarch64-macos-m1.tar.gz` | M1/M2/M3/M4 with ARM crypto extensions |

            ‚ö° **Recommended:** Optimized builds provide significantly better crypto performance (3-5x faster encryption).

            ü•ß **Raspberry Pi users:** Use the `aarch64-linux-gnu-rpi` variant to avoid illegal instruction errors on Pi 4/5.

            **Extract and use:**
            ```bash
            tar xzf floo-*.tar.gz
            cd floo-*/
            ./flooc --version
            ./floos --version
            ```

            ### üìñ Quick Start

            See the [README](https://github.com/${{ github.repository }}) for complete documentation including:
            - Configuration guide
            - CLI reference
            - Performance tuning
            - Proxy setup
            - Troubleshooting

            ### ‚ö†Ô∏è Security Note

            Before production use:
            1. Replace placeholder PSK and tokens in config files
            2. Run `--doctor` diagnostics to validate setup
            3. Use AEGIS-128L or AES-256-GCM cipher (never "none")

            ---

            **Built with ‚ù§Ô∏è in Zig**
